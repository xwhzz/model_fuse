import onnxruntime as ort
import onnx
import numpy as np
np.random.seed(0)

def run_fuse(model_num: int, index: list[int], data):
    so = ort.SessionOptions()
    so.graph_optimization_level = ort.GraphOptimizationLevel.ORT_DISABLE_ALL

    so.register_custom_ops_library('../libcustom_op_library.so')

    onnx_model = onnx.load(f'./model/fuse_{model_num}.onnx')

    sess = ort.InferenceSession(onnx_model.SerializeToString(), so, providers=['CPUExecutionProvider'])

    txout = sess.run(None, {
        'input_0': data,
        'input_1': np.concatenate([np.arange(0, 10) for _ in range(data.shape[0])]).reshape(-1, 10).astype(np.int64),
        "info": np.array(index).astype(np.int64)
        })
    
    return txout[0]

def run_model(path: str, start: int, end: int, data):
    so = ort.SessionOptions()
    so.graph_optimization_level = ort.GraphOptimizationLevel.ORT_DISABLE_ALL
    model = onnx.load(path)

    sess = ort.InferenceSession(model.SerializePartialToString(),so,providers=['CPUExecutionProvider'])

    txout = sess.run(None, {
        'hidden_states': data[start: end],
        'position_ids': np.concatenate([np.arange(0, 10) for _ in range(start, end)]).reshape(-1, 10).astype(np.int64)
    })

    return txout[0]

def test_res(model_num: int, index: list[int], data):
    model_path = []

    for i in range(1,model_num + 1):
        model_path.append(f'./model/model_{i}.onnx')
    res = []
    cur_index = 0
    for idx, p in enumerate(model_path):
        res.append(run_model(p, cur_index, cur_index + index[idx], data))
        cur_index += index[idx]

    res_cat = np.concatenate(res, axis=0)
    fuse_res = run_fuse(model_num, index, data)
    """
    注意之前存在误差的原因是，onnxruntime会进行graph-level optimization，例如对于transformer的第一层的op会fusion成一个layernorm算子。
    研究下为什么存在误差？ 这里应该存在问题
    """
    assert np.allclose(res_cat, fuse_res, atol=1e-5), (res_cat, fuse_res)

if __name__ == '__main__':
    
    data = np.random.random((5, 10,4096)).astype(np.float32)
    for i in range(1,5):
      print(i)
      test_res(2, [i,5-i], data)
"""
(array([[[-1.48203363e+01, -4.34999609e+00,  8.87244284e-01, ...,
          1.68695152e+00,  2.06219482e+00,  1.80100212e+01],
        [-1.85219994e+01, -1.92527756e-01,  1.75731361e+00, ...,
         -3.97467446e+00,  1.80083156e-01,  1.71206341e+01],
        [-1.01628275e+01, -1.82991326e+00, -1.08946872e+00, ...,
          2.57402825e+00, -1.33050010e-01,  1.73412094e+01],
        ...,
        [-1.09078121e+01, -3.39530659e+00, -3.16352487e+00, ...,
          4.60463688e-02, -2.07248354e+00,  1.44789190e+01],
        [-1.92757740e+01, -4.10648775e+00,  5.83384037e+00, ...,
         -4.43485737e+00,  9.77599859e-01,  1.76860104e+01],
        [-8.09950733e+00, -5.96295178e-01, -2.73712301e+00, ...,
          6.06192017e+00, -4.05038786e+00,  1.91216011e+01]],

       [[-1.39817533e+01, -2.45111179e+00,  3.37725520e+00, ...,
          6.22146010e-01,  5.21487379e+00,  1.79166737e+01],
        [-1.52107000e+01, -5.41319704e+00,  2.63960481e+00, ...,
         -1.02028751e+00,  3.39485693e+00,  1.59080238e+01],
        [-8.78613377e+00,  4.49811220e-02,  6.07730055e+00, ...,
          1.02329993e+00,  9.62439442e+00,  1.54182081e+01],
        ...,
        [-2.55089784e+00, -4.81780100e+00,  5.64474154e+00, ...,
          6.16659498e+00,  3.39888668e+00,  1.67814713e+01],
        [-1.85364532e+01, -3.26055479e+00, -2.15048289e+00, ...,
         -2.91952920e+00, -1.93513930e+00,  1.60220966e+01],
        [-5.33325958e+00,  8.61923218e-01,  3.48441839e+00, ...,
         -1.50747561e+00,  2.33430362e+00,  2.30549221e+01]],

       [[-1.47931242e+01, -4.57437849e+00,  2.30453658e+00, ...,
         -5.45350695e+00, -5.84213448e+00,  1.08048239e+01],
        [-1.00753851e+01, -3.01911569e+00,  3.26922393e+00, ...,
          3.91072726e+00,  1.23746306e-01,  4.34888983e+00],
        [-1.24142838e+01, -6.07983398e+00,  2.73007572e-01, ...,
          5.02750349e+00, -3.36008787e+00,  4.48318291e+00],
        ...,
        [-1.50657387e+01, -2.27196622e+00,  3.82477927e+00, ...,
          4.60721445e+00,  5.63373454e-02,  9.72429848e+00],
        [-9.28504753e+00, -4.10819197e+00,  2.87581229e+00, ...,
          7.84006453e+00, -5.19670725e-01,  6.49912262e+00],
        [-1.33867865e+01, -3.12130690e+00,  1.96696746e+00, ...,
          6.67909908e+00,  2.91286445e+00,  6.44136477e+00]],

       [[-3.41042972e+00, -1.18365078e+01,  3.61690730e-01, ...,
          8.10054207e+00, -1.47713547e+01,  1.49809580e+01],
        [-3.35148007e-01, -4.04069710e+00,  2.18886399e+00, ...,
          3.27634406e+00, -7.62777376e+00,  2.18463726e+01],
        [-5.84496021e+00,  4.65272158e-01,  7.74621439e+00, ...,
          1.45193350e+00,  1.02972364e+01,  1.43539743e+01],
        ...,
        [-6.57314348e+00, -7.31538391e+00,  1.60141575e+00, ...,
          7.61969709e+00, -6.50779676e+00,  1.54054861e+01],
        [-4.32794857e+00,  3.12082314e+00,  6.91805744e+00, ...,
          2.12254912e-01,  6.82597816e-01,  1.46423397e+01],
        [-4.80594444e+00, -2.86037970e+00,  3.08066368e+00, ...,
          3.86902666e+00, -5.56650972e+00,  1.58082914e+01]],

       [[-8.44321728e+00, -1.22545981e+00,  3.06990194e+00, ...,
          1.07345886e+01,  4.43400621e+00,  1.61523285e+01],
        [-6.99514818e+00, -4.14896774e+00, -1.41515326e+00, ...,
          8.18108177e+00, -3.30971813e+00,  1.61902657e+01],
        [-7.10042906e+00, -6.02958202e+00,  1.33637106e+00, ...,
          9.84881401e+00, -1.38359293e-02,  1.23886786e+01],
        ...,
        [-5.10006189e+00,  4.43408549e-01,  3.64594889e+00, ...,
          9.60015678e+00,  1.04589796e+00,  1.76803913e+01],
        [-4.62350750e+00, -4.49808264e+00,  2.71365452e+00, ...,
          5.93341589e+00, -1.93395400e+00,  1.35730753e+01],
        [-3.16962910e+00, -3.66832757e+00, -9.16092277e-01, ...,
          8.12223721e+00, -2.52700782e+00,  1.36445246e+01]]],
      dtype=float32), array([[[-1.48203392e+01, -4.34999561e+00,  8.87243569e-01, ...,
          1.68695056e+00,  2.06219459e+00,  1.80100212e+01],
        [-1.85219975e+01, -1.92529663e-01,  1.75731313e+00, ...,
         -3.97467685e+00,  1.80084586e-01,  1.71206341e+01],
        [-1.01628313e+01, -1.82991552e+00, -1.08946824e+00, ...,
          2.57403064e+00, -1.33046329e-01,  1.73412113e+01],
        ...,
        [-1.09078150e+01, -3.39530492e+00, -3.16352725e+00, ...,
          4.60475534e-02, -2.07248497e+00,  1.44789200e+01],
        [-1.92757721e+01, -4.10648966e+00,  5.83384800e+00, ...,
         -4.43485880e+00,  9.77599859e-01,  1.76860161e+01],
        [-8.09950733e+00, -5.96292973e-01, -2.73712277e+00, ...,
          6.06191921e+00, -4.05038881e+00,  1.91215992e+01]],

       [[-1.39817533e+01, -2.45111179e+00,  3.37725520e+00, ...,
          6.22146010e-01,  5.21487379e+00,  1.79166737e+01],
        [-1.52107000e+01, -5.41319704e+00,  2.63960481e+00, ...,
         -1.02028751e+00,  3.39485693e+00,  1.59080238e+01],
        [-8.78613377e+00,  4.49811220e-02,  6.07730055e+00, ...,
          1.02329993e+00,  9.62439442e+00,  1.54182081e+01],
        ...,
        [-2.55089784e+00, -4.81780100e+00,  5.64474154e+00, ...,
          6.16659498e+00,  3.39888668e+00,  1.67814713e+01],
        [-1.85364532e+01, -3.26055479e+00, -2.15048289e+00, ...,
         -2.91952920e+00, -1.93513930e+00,  1.60220966e+01],
        [-5.33325958e+00,  8.61923218e-01,  3.48441839e+00, ...,
         -1.50747561e+00,  2.33430362e+00,  2.30549221e+01]],

       [[-1.47931242e+01, -4.57437849e+00,  2.30453658e+00, ...,
         -5.45350695e+00, -5.84213448e+00,  1.08048239e+01],
        [-1.00753851e+01, -3.01911569e+00,  3.26922393e+00, ...,
          3.91072726e+00,  1.23746306e-01,  4.34888983e+00],
        [-1.24142838e+01, -6.07983398e+00,  2.73007572e-01, ...,
          5.02750349e+00, -3.36008787e+00,  4.48318291e+00],
        ...,
        [-1.50657387e+01, -2.27196622e+00,  3.82477927e+00, ...,
          4.60721445e+00,  5.63373454e-02,  9.72429848e+00],
        [-9.28504753e+00, -4.10819197e+00,  2.87581229e+00, ...,
          7.84006453e+00, -5.19670725e-01,  6.49912262e+00],
        [-1.33867865e+01, -3.12130690e+00,  1.96696746e+00, ...,
          6.67909908e+00,  2.91286445e+00,  6.44136477e+00]],

       [[-3.41042972e+00, -1.18365078e+01,  3.61690730e-01, ...,
          8.10054207e+00, -1.47713547e+01,  1.49809580e+01],
        [-3.35148007e-01, -4.04069710e+00,  2.18886399e+00, ...,
          3.27634406e+00, -7.62777376e+00,  2.18463726e+01],
        [-5.84496021e+00,  4.65272158e-01,  7.74621439e+00, ...,
          1.45193350e+00,  1.02972364e+01,  1.43539743e+01],
        ...,
        [-6.57314348e+00, -7.31538391e+00,  1.60141575e+00, ...,
          7.61969709e+00, -6.50779676e+00,  1.54054861e+01],
        [-4.32794857e+00,  3.12082314e+00,  6.91805744e+00, ...,
          2.12254912e-01,  6.82597816e-01,  1.46423397e+01],
        [-4.80594444e+00, -2.86037970e+00,  3.08066368e+00, ...,
          3.86902666e+00, -5.56650972e+00,  1.58082914e+01]],

       [[-8.44321728e+00, -1.22545981e+00,  3.06990194e+00, ...,
          1.07345886e+01,  4.43400621e+00,  1.61523285e+01],
        [-6.99514818e+00, -4.14896774e+00, -1.41515326e+00, ...,
          8.18108177e+00, -3.30971813e+00,  1.61902657e+01],
        [-7.10042906e+00, -6.02958202e+00,  1.33637106e+00, ...,
          9.84881401e+00, -1.38359293e-02,  1.23886786e+01],
        ...,
        [-5.10006189e+00,  4.43408549e-01,  3.64594889e+00, ...,
          9.60015678e+00,  1.04589796e+00,  1.76803913e+01],
        [-4.62350750e+00, -4.49808264e+00,  2.71365452e+00, ...,
          5.93341589e+00, -1.93395400e+00,  1.35730753e+01],
        [-3.16962910e+00, -3.66832757e+00, -9.16092277e-01, ...,
          8.12223721e+00, -2.52700782e+00,  1.36445246e+01]]],
      dtype=float32))

"""
